local ReplicatedStorage = game:GetService("ReplicatedStorage")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "HalloweenQueueUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 260, 0, 250)
Frame.Position = UDim2.new(0.5, -130, 0.5, -125)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Frame.BorderSizePixel = 0
Frame.BackgroundTransparency = 0.15
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = Frame

local glow = Instance.new("UIStroke")
glow.Color = Color3.fromRGB(255, 120, 0)
glow.Thickness = 1.2
glow.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 32)
Title.BackgroundTransparency = 1
Title.Text = "üéÉ Halloween Craft Queue"
Title.TextColor3 = Color3.fromRGB(255, 160, 50)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.Parent = Frame

local Line = Instance.new("Frame")
Line.Size = UDim2.new(1, -20, 0, 1)
Line.Position = UDim2.new(0, 10, 0, 33)
Line.BackgroundColor3 = Color3.fromRGB(255, 120, 0)
Line.BorderSizePixel = 0
Line.Parent = Frame

local Scrolling = Instance.new("ScrollingFrame")
Scrolling.Size = UDim2.new(1, -10, 1, -45)
Scrolling.Position = UDim2.new(0, 5, 0, 40)
Scrolling.BackgroundTransparency = 1
Scrolling.ScrollBarThickness = 4
Scrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
Scrolling.Parent = Frame

local Layout = Instance.new("UIListLayout")
Layout.Padding = UDim.new(0, 5)
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.Parent = Scrolling

-- === Funktionen ===
local function CreateGroupButton(petName, count, shiny)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -10, 0, 28)
	btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.TextXAlignment = Enum.TextXAlignment.Left
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	btn.AutoButtonColor = true
	btn.Text = string.format("%s%s √ó%d", petName, shiny and " ‚≠ê" or "", count)
	
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, 6)
	c.Parent = btn
	
	return btn
end

local function CreateSubEntry(i, mins)
	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, -20, 0, 22)
	lbl.BackgroundTransparency = 1
	lbl.TextColor3 = Color3.fromRGB(220, 220, 220)
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = 13
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Text = string.format("‚è≥ Slot #%d ‚Äî %dmin", i, mins)
	return lbl
end

-- === Popup Men√º f√ºr Details ===
local function ShowDetailsMenu(petName, entries)
	local Popup = Instance.new("Frame")
	Popup.Size = UDim2.new(0, 280, 0, 300)
	Popup.Position = UDim2.new(0.5, -140, 0.5, -150)
	Popup.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
	Popup.BorderSizePixel = 0
	Popup.Active = true
	Popup.Draggable = true
	Popup.Parent = ScreenGui

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 10)
	corner.Parent = Popup

	local glow = Instance.new("UIStroke")
	glow.Color = Color3.fromRGB(255, 120, 0)
	glow.Thickness = 1.1
	glow.Parent = Popup

	local Title = Instance.new("TextLabel")
	Title.Size = UDim2.new(1, -40, 0, 32)
	Title.Position = UDim2.new(0, 10, 0, 5)
	Title.BackgroundTransparency = 1
	Title.Text = "ü¶á " .. petName .. " Details"
	Title.TextColor3 = Color3.fromRGB(255, 160, 50)
	Title.Font = Enum.Font.GothamBold
	Title.TextSize = 16
	Title.TextXAlignment = Enum.TextXAlignment.Left
	Title.Parent = Popup

	local Close = Instance.new("TextButton")
	Close.Size = UDim2.new(0, 25, 0, 25)
	Close.Position = UDim2.new(1, -30, 0, 5)
	Close.BackgroundTransparency = 1
	Close.Text = "‚úñ"
	Close.TextColor3 = Color3.fromRGB(255, 120, 0)
	Close.Font = Enum.Font.GothamBold
	Close.TextSize = 18
	Close.Parent = Popup

	Close.MouseButton1Click:Connect(function()
		Popup:Destroy()
	end)

	local Line = Instance.new("Frame")
	Line.Size = UDim2.new(1, -20, 0, 1)
	Line.Position = UDim2.new(0, 10, 0, 35)
	Line.BackgroundColor3 = Color3.fromRGB(255, 120, 0)
	Line.BorderSizePixel = 0
	Line.Parent = Popup

	local Scrolling = Instance.new("ScrollingFrame")
	Scrolling.Size = UDim2.new(1, -10, 1, -45)
	Scrolling.Position = UDim2.new(0, 5, 0, 40)
	Scrolling.BackgroundTransparency = 1
	Scrolling.ScrollBarThickness = 4
	Scrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
	Scrolling.Parent = Popup

	local Layout = Instance.new("UIListLayout")
	Layout.Padding = UDim.new(0, 4)
	Layout.SortOrder = Enum.SortOrder.LayoutOrder
	Layout.Parent = Scrolling

	for i, entry in ipairs(entries) do
		local mins = math.floor((entry.Remaining or 0) / 60)
		local sub = CreateSubEntry(i, mins)
		sub.Parent = Scrolling
	end
end

-- === Queue Update ===
local function UpdateQueue()
	local success, data = pcall(function()
		return ReplicatedStorage.Network.HalloweenCraftingMachine_GetQueue:InvokeServer()
	end)

	for _, c in ipairs(Scrolling:GetChildren()) do
		if c:IsA("GuiObject") and c ~= Layout then
			c:Destroy()
		end
	end

	if not success or not data then
		local err = Instance.new("TextLabel")
		err.Size = UDim2.new(1, 0, 0, 20)
		err.BackgroundTransparency = 1
		err.Text = "Fehler beim Abrufen ‚ùå"
		err.TextColor3 = Color3.fromRGB(255, 80, 80)
		err.Font = Enum.Font.Gotham
		err.TextSize = 14
		err.Parent = Scrolling
		return
	end

	if #data == 0 then
		local none = Instance.new("TextLabel")
		none.Size = UDim2.new(1, 0, 0, 20)
		none.BackgroundTransparency = 1
		none.Text = "Keine aktiven Craftings."
		none.TextColor3 = Color3.fromRGB(180, 180, 180)
		none.Font = Enum.Font.Gotham
		none.TextSize = 14
		none.Parent = Scrolling
		return
	end

	local grouped = {}
	for _, entry in ipairs(data) do
		local petName = entry.Result and entry.Result.Data and entry.Result.Data.id or "?"
		grouped[petName] = grouped[petName] or {}
		table.insert(grouped[petName], entry)
	end

	for petName, entries in pairs(grouped) do
		local shiny = entries[1].Options and entries[1].Options.shiny
		local btn = CreateGroupButton(petName, #entries, shiny)
		btn.Parent = Scrolling
		btn.MouseButton1Click:Connect(function()
			ShowDetailsMenu(petName, entries)
		end)
	end
end

task.spawn(function()
	while true do
		UpdateQueue()
        task.wait(1)
	end
end)
